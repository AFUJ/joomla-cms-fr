!function(a){"object"==typeof exports&&"object"==typeof module?a(require("../../lib/codemirror"),require("diff_match_patch")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","diff_match_patch"],a):a(CodeMirror,diff_match_patch)}(function(a,b){"use strict";function c(a,b){this.mv=a,this.type=b,this.classes="left"==b?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function d(b){b.diffOutOfDate&&(b.diff=w(b.orig.getValue(),b.edit.getValue()),b.chunks=x(b.diff),b.diffOutOfDate=!1,a.signal(b.edit,"updateDiff",b.diff))}function e(a){function b(b){S=!0,l=!1,"full"==b&&(a.svg&&G(a.svg),a.copyButtons&&G(a.copyButtons),j(a.edit,h.marked,a.classes),j(a.orig,i.marked,a.classes),h.from=h.to=i.from=i.to=0),d(a),a.showDifferences&&(k(a.edit,a.diff,h,DIFF_INSERT,a.classes),k(a.orig,a.diff,i,DIFF_DELETE,a.classes)),m(a),"align"==a.mv.options.connect&&p(a),S=!1}function c(b){S||(a.dealigned=!0,e(b))}function e(a){S||l||(clearTimeout(g),a===!0&&(l=!0),g=setTimeout(b,a===!0?20:250))}function f(b,d){a.diffOutOfDate||(a.diffOutOfDate=!0,h.from=h.to=i.from=i.to=0),c(d.text.length-1!=d.to.line-d.from.line)}var g,h={from:0,to:0,marked:[]},i={from:0,to:0,marked:[]},l=!1;return a.edit.on("change",f),a.orig.on("change",f),a.edit.on("markerAdded",c),a.edit.on("markerCleared",c),a.orig.on("markerAdded",c),a.orig.on("markerCleared",c),a.edit.on("viewportChange",function(){e(!1)}),a.orig.on("viewportChange",function(){e(!1)}),b(),b}function f(a){a.edit.on("scroll",function(){g(a,DIFF_INSERT)&&m(a)}),a.orig.on("scroll",function(){g(a,DIFF_DELETE)&&m(a)})}function g(a,b){if(a.diffOutOfDate)return!1;if(!a.lockScroll)return!0;var c,d,e=+new Date;if(b==DIFF_INSERT?(c=a.edit,d=a.orig):(c=a.orig,d=a.edit),c.state.scrollSetBy==a&&(c.state.scrollSetAt||0)+50>e)return!1;var f=c.getScrollInfo();if("align"==a.mv.options.connect)q=f.top;else{var g,i,j=.5*f.clientHeight,k=f.top+j,l=c.lineAtHeight(k,"local"),m=A(a.chunks,l,b==DIFF_INSERT),n=h(c,b==DIFF_INSERT?m.edit:m.orig),o=h(d,b==DIFF_INSERT?m.orig:m.edit),p=(k-n.top)/(n.bot-n.top),q=o.top-j+p*(o.bot-o.top);if(q>f.top&&(i=f.top/j)<1)q=q*i+f.top*(1-i);else if((g=f.height-f.clientHeight-f.top)<j){var r=d.getScrollInfo(),s=r.height-r.clientHeight-q;s>g&&(i=g/j)<1&&(q=q*i+(r.height-r.clientHeight-g)*(1-i))}}return d.scrollTo(f.left,q),d.state.scrollSetAt=e,d.state.scrollSetBy=a,!0}function h(a,b){var c=b.after;return null==c&&(c=a.lastLine()+1),{top:a.heightAtLine(b.before||0,"local"),bot:a.heightAtLine(c,"local")}}function i(a,b,c){a.lockScroll=b,b&&0!=c&&g(a,DIFF_INSERT)&&m(a),a.lockButton.innerHTML=b?"⇛⇚":"⇛&nbsp;&nbsp;⇚"}function j(b,c,d){for(var e=0;e<c.length;++e){var f=c[e];f instanceof a.TextMarker?f.clear():f.parent&&(b.removeLineClass(f,"background",d.chunk),b.removeLineClass(f,"background",d.start),b.removeLineClass(f,"background",d.end))}c.length=0}function k(a,b,c,d,e){var f=a.getViewport();a.operation(function(){c.from==c.to||f.from-c.to>20||c.from-f.to>20?(j(a,c.marked,e),l(a,b,d,c.marked,f.from,f.to,e),c.from=f.from,c.to=f.to):(f.from<c.from&&(l(a,b,d,c.marked,f.from,c.from,e),c.from=f.from),f.to>c.to&&(l(a,b,d,c.marked,c.to,f.to,e),c.to=f.to))})}function l(a,b,c,d,e,f,g){function h(b,c){for(var h=Math.max(e,b),i=Math.min(f,c),j=h;i>j;++j){var k=a.addLineClass(j,"background",g.chunk);j==b&&a.addLineClass(k,"background",g.start),j==c-1&&a.addLineClass(k,"background",g.end),d.push(k)}b==c&&h==c&&i==c&&(h?d.push(a.addLineClass(h-1,"background",g.end)):d.push(a.addLineClass(h,"background",g.start)))}for(var i=Q(0,0),j=Q(e,0),k=a.clipPos(Q(f-1)),l=c==DIFF_DELETE?g.del:g.insert,m=0,n=0;n<b.length;++n){var o=b[n],p=o[0],q=o[1];if(p==DIFF_EQUAL){var r=i.line+(z(b,n)?0:1);J(i,q);var s=i.line+(y(b,n)?1:0);s>r&&(n&&h(m,r),m=s)}else if(p==c){var t=J(i,q,!0),u=L(j,i),v=K(k,t);M(u,v)||d.push(a.markText(u,v,{className:l})),i=t}}m<=i.line&&h(m,i.line+1)}function m(a){if(a.showDifferences){if(a.svg){G(a.svg);var b=a.gap.offsetWidth;H(a.svg,"width",b,"height",a.gap.offsetHeight)}a.copyButtons&&G(a.copyButtons);for(var c=a.edit.getViewport(),d=a.orig.getViewport(),e=a.edit.getScrollInfo().top,f=a.orig.getScrollInfo().top,g=0;g<a.chunks.length;g++){var h=a.chunks[g];h.editFrom<=c.to&&h.editTo>=c.from&&h.origFrom<=d.to&&h.origTo>=d.from&&s(a,h,f,e,b)}}}function n(a,b){for(var c=0,d=0,e=0;e<b.length;e++){var f=b[e];if(f.editTo>a&&f.editFrom<=a)return null;if(f.editFrom>a)break;c=f.editTo,d=f.origTo}return d+(a-c)}function o(a,b){for(var c=[],d=0;d<a.chunks.length;d++){var e=a.chunks[d];c.push([e.origTo,e.editTo,b?n(e.editTo,b.chunks):null])}if(b)for(var d=0;d<b.chunks.length;d++){for(var e=b.chunks[d],f=0;f<c.length;f++){var g=c[f];if(g[1]==e.editTo){f=-1;break}if(g[1]>e.editTo)break}f>-1&&c.splice(f-1,0,[n(e.editTo,a.chunks),e.editTo,e.origTo])}return c}function p(a,b){if(a.dealigned||b){if(!a.orig.curOp)return a.orig.operation(function(){p(a,b)});a.dealigned=!1;var c=a.mv.left==a?a.mv.right:a.mv.left;c&&(d(c),c.dealigned=!1);for(var e=o(a,c),f=a.mv.aligners,g=0;g<f.length;g++)f[g].clear();f.length=0;var h=[a.orig,a.edit],i=[];c&&h.push(c.orig);for(var g=0;g<h.length;g++)i.push(h[g].getScrollInfo().top);for(var j=0;j<e.length;j++)q(h,e[j],f);for(var g=0;g<h.length;g++)h[g].scrollTo(null,i[g])}}function q(a,b,c){for(var d=0,e=[],f=0;f<a.length;f++)if(null!=b[f]){var g=a[f].heightAtLine(b[f],"local");e[f]=g,d=Math.max(d,g)}for(var f=0;f<a.length;f++)if(null!=b[f]){var h=d-e[f];h>1&&c.push(r(a[f],b[f],h))}}function r(a,b,c){var d=!0;b>a.lastLine()&&(b--,d=!1);var e=document.createElement("div");return e.className="CodeMirror-merge-spacer",e.style.height=c+"px",e.style.minWidth="1px",a.addLineWidget(b,e,{height:c,above:d})}function s(a,b,c,d,e){var f="left"==a.type,g=a.orig.heightAtLine(b.origFrom,"local")-c;if(a.svg){var h=g,i=a.edit.heightAtLine(b.editFrom,"local")-d;if(f){var j=h;h=i,i=j}var k=a.orig.heightAtLine(b.origTo,"local")-c,l=a.edit.heightAtLine(b.editTo,"local")-d;if(f){var j=k;k=l,l=j}var m=" C "+e/2+" "+i+" "+e/2+" "+h+" "+(e+2)+" "+h,n=" C "+e/2+" "+k+" "+e/2+" "+l+" -1 "+l;H(a.svg.appendChild(document.createElementNS(R,"path")),"d","M -1 "+i+m+" L "+(e+2)+" "+k+n+" z","class",a.classes.connect)}if(a.copyButtons){var o=a.copyButtons.appendChild(F("div","left"==a.type?"⇝":"⇜","CodeMirror-merge-copy")),p=a.mv.options.allowEditingOriginals;if(o.title=p?"Push to left":"Revert chunk",o.chunk=b,o.style.top=g+"px",p){var q=a.orig.heightAtLine(b.editFrom,"local")-d,r=a.copyButtons.appendChild(F("div","right"==a.type?"⇝":"⇜","CodeMirror-merge-copy-reverse"));r.title="Push to right",r.chunk={editFrom:b.origFrom,editTo:b.origTo,origFrom:b.editFrom,origTo:b.editTo},r.style.top=q+"px","right"==a.type?r.style.left="2px":r.style.right="2px"}}}function t(a,b,c,d){a.diffOutOfDate||b.replaceRange(c.getRange(Q(d.origFrom,0),Q(d.origTo,0)),Q(d.editFrom,0),Q(d.editTo,0))}function u(b){var c=b.lockButton=F("div",null,"CodeMirror-merge-scrolllock");c.title="Toggle locked scrolling";var d=F("div",[c],"CodeMirror-merge-scrolllock-wrap");a.on(c,"click",function(){i(b,!b.lockScroll)});var e=[d];if(b.mv.options.revertButtons!==!1&&(b.copyButtons=F("div",null,"CodeMirror-merge-copybuttons-"+b.type),a.on(b.copyButtons,"click",function(a){var c=a.target||a.srcElement;if(c.chunk)return"CodeMirror-merge-copy-reverse"==c.className?void t(b,b.orig,b.edit,c.chunk):void t(b,b.edit,b.orig,c.chunk)}),e.unshift(b.copyButtons)),"align"!=b.mv.options.connect){var f=document.createElementNS&&document.createElementNS(R,"svg");f&&!f.createSVGRect&&(f=null),b.svg=f,f&&e.push(f)}return b.gap=F("div",e,"CodeMirror-merge-gap")}function v(a){return"string"==typeof a?a:a.getValue()}function w(a,b){var c=U.diff_main(a,b);U.diff_cleanupSemantic(c);for(var d=0;d<c.length;++d){var e=c[d];e[1]?d&&c[d-1][0]==e[0]&&(c.splice(d--,1),c[d][1]+=e[1]):c.splice(d--,1)}return c}function x(a){for(var b=[],c=0,d=0,e=Q(0,0),f=Q(0,0),g=0;g<a.length;++g){var h=a[g],i=h[0];if(i==DIFF_EQUAL){var j=z(a,g)?0:1,k=e.line+j,l=f.line+j;J(e,h[1],null,f);var m=y(a,g)?1:0,n=e.line+m,o=f.line+m;n>k&&(g&&b.push({origFrom:d,origTo:l,editFrom:c,editTo:k}),c=n,d=o)}else J(i==DIFF_INSERT?e:f,h[1])}return(c<=e.line||d<=f.line)&&b.push({origFrom:d,origTo:f.line+1,editFrom:c,editTo:e.line+1}),b}function y(a,b){if(b==a.length-1)return!0;var c=a[b+1][1];return 1==c.length||10!=c.charCodeAt(0)?!1:b==a.length-2?!0:(c=a[b+2][1],c.length>1&&10==c.charCodeAt(0))}function z(a,b){if(0==b)return!0;var c=a[b-1][1];return 10!=c.charCodeAt(c.length-1)?!1:1==b?!0:(c=a[b-2][1],10==c.charCodeAt(c.length-1))}function A(a,b,c){for(var d,e,f,g,h=0;h<a.length;h++){var i=a[h],j=c?i.editFrom:i.origFrom,k=c?i.editTo:i.origTo;null==e&&(j>b?(e=i.editFrom,g=i.origFrom):k>b&&(e=i.editTo,g=i.origTo)),b>=k?(d=i.editTo,f=i.origTo):b>=j&&(d=i.editFrom,f=i.origFrom)}return{edit:{before:d,after:e},orig:{before:f,after:g}}}function B(a,b,c){function d(){f.clear(),a.removeLineClass(b,"wrap","CodeMirror-merge-collapsed-line")}a.addLineClass(b,"wrap","CodeMirror-merge-collapsed-line");var e=document.createElement("span");e.className="CodeMirror-merge-collapsed-widget",e.title="Identical text collapsed. Click to expand.";var f=a.markText(Q(b,0),Q(c-1),{inclusiveLeft:!0,inclusiveRight:!0,replacedWith:e,clearOnEnter:!0});return e.addEventListener("click",d),{mark:f,clear:d}}function C(a,b){function c(){for(var a=0;a<d.length;a++)d[a].clear()}for(var d=[],e=0;e<b.length;e++){var f=b[e],g=B(f.cm,f.line,f.line+a);d.push(g),g.mark.on("clear",c)}return d[0].mark}function D(a,b,c,d){for(var e=0;e<a.chunks.length;e++)for(var f=a.chunks[e],g=f.editFrom-b;g<f.editTo+b;g++){var h=g+c;h>=0&&h<d.length&&(d[h]=!1)}}function E(a,b){"number"!=typeof b&&(b=2);for(var c=[],d=a.editor(),e=d.firstLine(),f=e,g=d.lastLine();g>=f;f++)c.push(!0);a.left&&D(a.left,b,e,c),a.right&&D(a.right,b,e,c);for(var h=0;h<c.length;h++)if(c[h]){for(var i=h+e,j=1;h<c.length-1&&c[h+1];h++,j++);if(j>b){var k=[{line:i,cm:d}];a.left&&k.push({line:n(i,a.left.chunks),cm:a.left.orig}),a.right&&k.push({line:n(i,a.right.chunks),cm:a.right.orig});var l=C(j,k);a.options.onCollapse&&a.options.onCollapse(a,i,j,l)}}}function F(a,b,c,d){var e=document.createElement(a);if(c&&(e.className=c),d&&(e.style.cssText=d),"string"==typeof b)e.appendChild(document.createTextNode(b));else if(b)for(var f=0;f<b.length;++f)e.appendChild(b[f]);return e}function G(a){for(var b=a.childNodes.length;b>0;--b)a.removeChild(a.firstChild)}function H(a){for(var b=1;b<arguments.length;b+=2)a.setAttribute(arguments[b],arguments[b+1])}function I(a,b){b||(b={});for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function J(a,b,c,d){for(var e=c?Q(a.line,a.ch):a,f=0;;){var g=b.indexOf("\n",f);if(-1==g)break;++e.line,d&&++d.line,f=g+1}return e.ch=(f?0:e.ch)+(b.length-f),d&&(d.ch=(f?0:d.ch)+(b.length-f)),e}function K(a,b){return(a.line-b.line||a.ch-b.ch)<0?a:b}function L(a,b){return(a.line-b.line||a.ch-b.ch)>0?a:b}function M(a,b){return a.line==b.line&&a.ch==b.ch}function N(a,b,c){for(var d=a.length-1;d>=0;d--){var e=a[d],f=(c?e.origTo:e.editTo)-1;if(b>f)return f}}function O(a,b,c){for(var d=0;d<a.length;d++){var e=a[d],f=c?e.origFrom:e.editFrom;if(f>b)return f}}function P(b,c){var e=null,f=b.state.diffViews,g=b.getCursor().line;if(f)for(var h=0;h<f.length;h++){var i=f[h],j=b==i.orig;d(i);var k=0>c?N(i.chunks,g,j):O(i.chunks,g,j);null==k||null!=e&&!(0>c?k>e:e>k)||(e=k)}return null==e?a.Pass:void b.setCursor(e,0)}var Q=a.Pos,R="http://www.w3.org/2000/svg";c.prototype={constructor:c,init:function(b,c,d){this.edit=this.mv.edit,(this.edit.state.diffViews||(this.edit.state.diffViews=[])).push(this),this.orig=a(b,I({value:c,readOnly:!this.mv.options.allowEditingOriginals},I(d))),this.orig.state.diffViews=[this],this.diff=w(v(c),v(d.value)),this.chunks=x(this.diff),this.diffOutOfDate=this.dealigned=!1,this.showDifferences=d.showDifferences!==!1,this.forceUpdate=e(this),i(this,!0,!1),f(this)},setShowDifferences:function(a){a=a!==!1,a!=this.showDifferences&&(this.showDifferences=a,this.forceUpdate("full"))}};var S=!1,T=a.MergeView=function(b,d){if(!(this instanceof T))return new T(b,d);this.options=d;var e=d.origLeft,f=null==d.origRight?d.orig:d.origRight,g=null!=e,h=null!=f,i=1+(g?1:0)+(h?1:0),j=[],k=this.left=null,l=this.right=null,n=this;if(g){k=this.left=new c(this,"left");var o=F("div",null,"CodeMirror-merge-pane");j.push(o),j.push(u(k))}var q=F("div",null,"CodeMirror-merge-pane");if(j.push(q),h){l=this.right=new c(this,"right"),j.push(u(l));var r=F("div",null,"CodeMirror-merge-pane");j.push(r)}(h?r:q).className+=" CodeMirror-merge-pane-rightmost",j.push(F("div",null,null,"height: 0; clear: both;"));var s=this.wrap=b.appendChild(F("div",j,"CodeMirror-merge CodeMirror-merge-"+i+"pane"));this.edit=a(q,I(d)),k&&k.init(o,e,d),l&&l.init(r,f,d),d.collapseIdentical&&(S=!0,this.editor().operation(function(){E(n,d.collapseIdentical)}),S=!1),"align"==d.connect&&(this.aligners=[],p(this.left||this.right,!0));var t=function(){k&&m(k),l&&m(l)};a.on(window,"resize",t);var v=setInterval(function(){for(var b=s.parentNode;b&&b!=document.body;b=b.parentNode);b||(clearInterval(v),a.off(window,"resize",t))},5e3)};T.prototype={constuctor:T,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(a){this.right&&this.right.setShowDifferences(a),this.left&&this.left.setShowDifferences(a)},rightChunks:function(){return this.right?(d(this.right),this.right.chunks):void 0},leftChunks:function(){return this.left?(d(this.left),this.left.chunks):void 0}};var U=new b;a.commands.goNextDiff=function(a){return P(a,1)},a.commands.goPrevDiff=function(a){return P(a,-1)}});