/**
 * @package		Joomla.JavaScript
 * @copyright	Copyright (C) 2005 - 2016 Open Source Matters, Inc. All rights reserved.
 * @license		GNU General Public License version 2 or later; see LICENSE.txt
 */
!function(a){"use strict";a.JRepeatable=function(b,c){var d=this;return d&&d!==window?(d.$input=a(b),d.$input.data("JRepeatable")?d:(d.$input.data("JRepeatable",d),d.init=function(){d.options=a.extend({},a.JRepeatable.defaults,c),d.$container=a(d.options.container),a("body").append(d.$container),d.$rowsContainer=d.$container.find(d.options.repeatableElement).parent(),d.prepareModal(),d.inputs=[],d.values={},d.prepareTemplate();var b=d.$input.val();if(b)try{d.values=JSON.parse(b)}catch(a){if(a instanceof SyntaxError)try{b=b.replace(/'/g,'"').replace(/\\"/g,"'"),d.values=JSON.parse(b)}catch(a){window.console&&console.log(a)}else window.console&&console.log(a)}d.buildRows(),a(document).on("click",d.options.btModalOpen,function(a){a.preventDefault(),d.$modalWindow.modal("show")}),d.$modalWindow.on("click",d.options.btModalClose,function(a){a.preventDefault(),d.$modalWindow.modal("hide"),d.buildRows()}),d.$modalWindow.on("click",d.options.btModalSaveData,function(a){a.preventDefault(),d.$modalWindow.modal("hide"),d.refreshValue()}),d.$container.on("click",d.options.btAdd,function(b){b.preventDefault();var c=a(this).parents(d.options.repeatableElement);c.length||(c=null),d.addRow(c)}),d.$container.on("click",d.options.btRemove,function(b){b.preventDefault();var c=a(this).parents(d.options.repeatableElement);d.removeRow(c)}),d.$input.trigger("weready")},d.prepareTemplate=function(){var b=d.$container.find(d.options.repeatableElement),c=a(b.get(0));try{d.clearScripts(c)}catch(a){window.console&&console.log(a)}for(var e=c.find("*[name]"),f=0,g=e.length;f<g;f++){var h=a(e[f]).attr("name");d.values[h]||(d.inputs.push({name:h,type:a(e[f]).attr("type")||e[f].tagName.toLowerCase()}),d.values[h]=[])}d.template=c.prop("outerHTML"),b.remove(),d.$input.trigger("prepare-template",d.template)},d.prepareModal=function(){var b=a(d.options.modalElement);b.css({position:"absolute",width:"auto","max-width":"100%"}),b.on("shown",function(){d.resizeModal()}),a(window).resize(function(){d.resizeModal()}),d.$modalWindow=b.modal({show:!1,backdrop:"static"}),d.$input.trigger("prepare-modal",d.$modalWindow)},d.resizeModal=function(){if(d.$modalWindow.is(":visible")){var b=a(document).width()/2,c=d.$modalWindow.width()/2,e=d.$rowsContainer.width()/2,f=c>=b?0:-c,g=f?"50%":0,h=a(document).scrollTop()+.2*a(window).height();d.$modalWindow.css({top:h,left:g,"margin-left":f,overflow:e>c?"auto":"visible"})}},d.buildRows=function(){var a=d.$rowsContainer.children();a.length&&d.removeRow(a);for(var b=d.values[Object.keys(d.values)[0]].length||1,c=null,e=0;e<b;e++)c=d.addRow(c,e)},d.addRow=function(b,c){var e=d.$container.find(d.options.repeatableElement).length;if(e>=d.options.maximum)return null;var f=a.parseHTML(d.template);b?a(b).after(f):d.$rowsContainer.append(f);var g=a(f);if(d.fixUniqueAttributes(g,e+1),null!==c&&void 0!==c)for(var h=0,i=d.inputs.length;h<i;h++){var j=d.inputs[h].name,k=d.inputs[h].type,l=null;if(d.values[j]&&(l=d.values[j][c]),null!==l&&void 0!==l)if("radio"===k)g.find('*[name*="'+j+'"][value="'+l+'"]').attr("checked","checked");else if("checkbox"===k)if(l.length)for(var m=0,n=l.length;m<n;m++)g.find('*[name*="'+j+'"][value="'+l[m]+'"]').attr("checked","checked");else g.find('*[name*="'+j+'"][value="'+l+'"]').attr("checked","checked");else g.find('*[name*="'+j+'"]').val(l)}try{d.fixScripts(g)}catch(a){window.console&&console.log(a)}return d.$input.trigger("row-add",g),g},d.removeRow=function(b){d.$input.trigger("row-remove",b),a(b).remove()},d.fixUniqueAttributes=function(a,b){var c=a.find("*[id]");d.increaseAttrName(c,"id",b);var e=a.find("label[for]");d.increaseAttrName(e,"for",b);var f=a.find("*[name]");d.increaseAttrName(f,"name",b)},d.increaseAttrName=function(b,c,d){for(var e=0,f=b.length;e<f;e++){var g=a(b[e]),h=g.attr(c);g.attr(c,d+"-"+h)}},d.refreshValue=function(){var b=d.$container.find(d.options.repeatableElement);d.values={};for(var c=0,e=d.inputs.length;c<e;c++){var f=d.inputs[c].name,g=d.inputs[c].type;d.values[f]=[];for(var h=0,i=b.length;h<i;h++){var j=a(b[h]),k=null;if("radio"===g)k=j.find('*[name*="'+f+'"]:checked').val();else if("checkbox"===g){var l=j.find('*[name*="'+f+'"]:checked');if(l.length>1){k=[];for(var m=0,n=l.length;m<n;m++)k.push(a(l[m]).val())}else k=l.val()}else k=j.find('*[name*="'+f+'"]').val();k=null===k?"":k,d.values[f].push(k)}}d.$input.val(JSON.stringify(d.values)),d.$input.trigger("value-update",d.values)},d.clearScripts=function(b){a.fn.chosen&&b.find("select.chzn-done").chosen("destroy"),a.fn.minicolors&&b.find(".minicolors input").each(function(){a(this).minicolors("destroy",a(this))})},d.fixScripts=function(b){a.fn.chosen&&b.find("select").chosen(),b.find(".minicolors").each(function(){var b=a(this);b.minicolors({control:b.attr("data-control")||"hue",position:b.attr("data-position")||"right",theme:"bootstrap"})}),b.find('a[onclick*="jInsertFieldValue"]').each(function(){var b=a(this),c=b.siblings('input[type="text"]').attr("id"),d=b.prev(),e=d.attr("href");b.attr("onclick","jInsertFieldValue('', '"+c+"');return false;"),d.attr("href",e.replace(/&fieldid=(.+)&/,"&fieldid="+c+"&")),jMediaRefreshPreview(c)}),window.SqueezeBox&&SqueezeBox.assign(b.find("a.modal").get(),{parse:"rel"})},void d.init())):new a.JRepeatable(b,c)},a.JRepeatable.defaults={modalElement:"#modal-container",btModalOpen:"#open-modal",btModalClose:".close-modal",btModalSaveData:".save-modal-data",btAdd:"a.add",btRemove:"a.remove",maximum:10,repeatableElement:"table tbody tr"},a.fn.JRepeatable=function(b){return this.each(function(){var b=b||{},c=a(this).data();for(var d in c)c.hasOwnProperty(d)&&(b[d]=c[d]);new a.JRepeatable(this,b)})},a(window).on("load",function(){a("input.form-field-repeatable").JRepeatable()})}(jQuery);