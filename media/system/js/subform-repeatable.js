!(function(e){"use strict";e.subformRepeatable=function(t,a){if(this.$container=e(t),this.$container.data("subformRepeatable"))return o;this.$container.data("subformRepeatable",o),this.options=e.extend({},e.subformRepeatable.defaults,a),this.template="",this.prepareTemplate(),this.$containerRows=this.options.rowsContainer?this.$container.find(this.options.rowsContainer):this.$container,this.lastRowNum=this.$containerRows.find(this.options.repeatableElement).length;var o=this;this.$container.on("click",this.options.btAdd,(function(t){t.preventDefault();var a=e(this).parents(o.options.repeatableElement);a.length||(a=null),o.addRow(a)})),this.$container.on("click",this.options.btRemove,(function(t){t.preventDefault();var a=e(this).parents(o.options.repeatableElement);o.removeRow(a)})),this.options.btMove&&this.$containerRows.sortable({items:this.options.repeatableElement,handle:this.options.btMove,tolerance:"pointer"}),this.$container.trigger("subform-ready")},e.subformRepeatable.prototype.prepareTemplate=function(){if(this.options.rowTemplateSelector){var t=this.$container.find(this.options.rowTemplateSelector)[0]||{};this.template=e.trim(t.text||t.textContent)}else{var a=this.$container.find(this.options.repeatableElement).get(0),o=e(a).clone();try{this.clearScripts(o)}catch(e){window.console&&console.log(e)}this.template=o.prop("outerHTML")}},e.subformRepeatable.prototype.addRow=function(t){var a=this.$containerRows.find(this.options.repeatableElement).length;if(a>=this.options.maximum)return null;var o=e.parseHTML(this.template);t?e(t).after(o):this.$containerRows.append(o);var r=e(o);r.attr("data-new","true"),this.fixUniqueAttributes(r,a);try{this.fixScripts(r)}catch(e){window.console&&console.log(e)}return this.$container.trigger("subform-row-add",r),r},e.subformRepeatable.prototype.removeRow=function(e){this.$containerRows.find(this.options.repeatableElement).length<=this.options.minimum||(this.$container.trigger("subform-row-remove",e),e.remove())},e.subformRepeatable.prototype.fixUniqueAttributes=function(t,a){this.lastRowNum++;var o=t.attr("data-group"),r=t.attr("data-base-name"),i=(a=a||0,Math.max(this.lastRowNum,a+1)),n=r+i;this.lastRowNum=i,t.attr("data-group",n);for(var s=t.find("[name]"),l={},p=0,f=s.length;p<f;p++){var c=e(s[p]),h=c.attr("name"),u=h.replace(/(\[\]$)/g,"").replace(/(\]\[)/g,"__").replace(/\[/g,"_").replace(/\]/g,""),d=h.replace("["+o+"][","["+n+"]["),m=u.replace(o,n),b=0,w=u;"checkbox"===c.prop("type")&&h.match(/\[\]$/)?((b=l[u]?l[u].length:0)||(c.closest("fieldset.checkboxes").attr("id",m),t.find('label[for="'+u+'"]').attr("for",m).attr("id",m+"-lbl")),w+=b,m+=b):"radio"===c.prop("type")&&((b=l[u]?l[u].length:0)||(c.closest("fieldset.radio").attr("id",m),t.find('label[for="'+u+'"]').attr("for",m).attr("id",m+"-lbl")),w+=b,m+=b),l[u]?l[u].push(!0):l[u]=[!0],c.attr("name",d),c.attr("id",m),t.find('label[for="'+w+'"]').attr("for",m).attr("id",m+"-lbl")}},e.subformRepeatable.prototype.clearScripts=function(t){e.fn.chosen&&t.find("select.chzn-done").each((function(){var t=e(this);t.next(".chzn-container").remove(),t.show().addClass("fix-chosen")}))},e.subformRepeatable.prototype.fixScripts=function(t){t.find('a[onclick*="jInsertFieldValue"]').each((function(){var t=e(this),a=t.siblings('input[type="text"]').attr("id"),o=t.prev(),r=o.attr("href");t.attr("onclick","jInsertFieldValue('', '"+a+"');return false;"),o.attr("href",r.replace(/&fieldid=(.+)&/,"&fieldid="+a+"&"))})),e.fn.fieldMedia&&t.find(".field-media-wrapper").fieldMedia(),e.fn.fieldUser&&t.find(".field-user-wrapper").fieldUser(),window.SqueezeBox&&window.SqueezeBox.assign&&SqueezeBox.assign(t.find("a.modal").get(),{parse:"rel"})},e.subformRepeatable.defaults={btAdd:".group-add",btRemove:".group-remove",btMove:".group-move",minimum:0,maximum:10,repeatableElement:".subform-repeatable-group",rowTemplateSelector:"script.subform-repeatable-template-section",rowsContainer:null},e.fn.subformRepeatable=function(t){return this.each((function(){var t=t||{},a=e(this).data();if(!a.subformRepeatable){for(var o in a)a.hasOwnProperty(o)&&(t[o]=a[o]);var r=new e.subformRepeatable(this,t);e(this).data("subformRepeatable",r)}}))},e(window).on("load",(function(){e("div.subform-repeatable").subformRepeatable()}))})(jQuery);

